<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Symptom Checker ‚Ä¢ SalFa Health</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
<style>
:root{
  --bg: linear-gradient(135deg,#dbeafe,#fef9c3);
  --primary:#fff; --text:#121212; --accent:#0077ff;
  --ai-bg:#1a1a1a; --ai-text:#e5e5e5;
  --highlight-bg:#fff59d; --highlight-color:#000;
}
[data-theme='dark']{
  --bg: linear-gradient(135deg,#111827,#1f2937);
  --primary:#1a1a1a; --text:#e5e5e5; --accent:#66a3ff;
  --ai-bg:#2c2c2c; --ai-text:#f0f0f0;
  --highlight-bg:#fdd835; --highlight-color:#000;
}
*{box-sizing:border-box;}
body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh;overflow:hidden;}
header{position:sticky;top:0;padding:1rem;background:var(--primary);border-bottom:1px solid rgba(0,0,0,0.1);z-index:999;font-weight:600;display:flex;justify-content:center;align-items:center;}
main{flex:1;display:flex;flex-direction:column;max-width:720px;margin:auto;padding:0.5rem;gap:0.5rem;overflow:hidden;position:relative;}
#severitySummary{position:sticky;top:0;z-index:1000;padding:0.8rem 1rem;background:rgba(0,0,0,0.05);font-weight:600;border-radius:0 0 10px 10px;}
.chat-container{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:0.5rem;padding-bottom:150px;margin-top:0.5rem;}
.bubble{padding:0.7rem 1rem;border-radius:12px;max-width:80%;position:relative;font-size:0.95rem;line-height:1.4;word-wrap:break-word;}
.user{background:var(--accent);color:#fff;align-self:flex-start;border-top-left-radius:0;}
.ai{background:var(--ai-bg);color:var(--ai-text);align-self:flex-end;border-top-right-radius:0;}
.timestamp{font-size:0.7rem;color:rgba(0,0,0,0.5);margin-top:0.2rem;}
.severity{font-weight:600;margin-top:0.3rem;display:inline-block;padding:0.3rem 0.6rem;border-radius:6px;}
.moderate{background:#ffc10730;color:#ffc107;}
.urgent{background:#ff3b3b30;color:#ff3b3b;}
textarea{width:calc(100% - 1rem);padding:0.75rem;border-radius:10px;border:1px solid rgba(0,0,0,0.2);outline:none;resize:none;min-height:60px;max-height:200px;overflow-y:auto;font-size:1rem;}
#inputContainer{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);width:90%;max-width:720px;display:flex;gap:0.5rem;align-items:flex-end;z-index:999;}
#inputContainer button{margin-top:0;padding:0.8rem 1rem; border-radius: 10px;}
    #inputContainer button:disabled {
      background:#ccc; cursor:not-allowed;
    }
    #inputContainer button:hover:not(:disabled) {
      background:#005fcc;
    }
.highlight{background:var(--highlight-bg);color:var(--highlight-color);font-weight:600;padding:0 2px;}
ul, ol{padding-left:1.5rem;margin:0.3rem 0; line-height:1.6; font-weight:500;}
ul{list-style: disc inside; color:var(--accent);}
ol{list-style: decimal inside; color:var(--accent);}
ul li, ol li{margin:0.25rem 0; transition:all 0.2s ease; cursor:default;}
ul li:hover, ol li:hover{color:#ff6f61; transform:scale(1.05);}
footer{position:sticky;bottom:0;text-align:center;padding:0.5rem;font-size:0.85rem;border-top:1px solid rgba(0,0,0,0.1);background:var(--primary);}
#scrollUpBtn{position:fixed;bottom:100px;right:20px;background:var(--accent);color:#fff;border:none;padding:0.6rem 0.9rem;border-radius:50%;cursor:pointer;display:none;z-index:999;box-shadow:0 2px 6px rgba(0,0,0,0.3);}
.cursor{display:inline-block;width:2px;background:#fff;animation:blink 1s infinite;vertical-align:middle;}
@keyframes blink{50%{opacity:0;}}
</style>
</head>
<body>
<header><i class="fa-solid fa-stethoscope"></i> Symptom Checker ‚Ä¢ SalFa AI</header>
<main>
<div id="severitySummary">No severity data yet.</div>
<div class="chat-container" id="chatContainer"></div>
</main>
<div id="inputContainer">
<textarea id="userInput" placeholder="ü§ñ What can I help you with..."></textarea>
<button id="btnSend" type="button" disabled><i class="fa-solid fa-magnifying-glass"></i> Analyze</button>
</div>
<footer>&copy; 2025 SalFa Health</footer>
<button id="scrollUpBtn"><i class="fa-solid fa-arrow-up"></i></button>

<script type="module">
const chatContainer=document.getElementById("chatContainer");
const userInput=document.getElementById("userInput");
const btnSend=document.getElementById("btnSend");
const scrollUpBtn=document.getElementById("scrollUpBtn");
const severitySummary=document.getElementById("severitySummary");
const lang=localStorage.getItem("lang")||"en";
const symptomKeywords=["homa","kikohoa","kichwa kuuma","fever","cough","headache","fatigue"];
const typeSound=new Audio("https://www.soundjay.com/button/sounds/button-16.mp3");

function timeAgo(ts){
  const d=new Date(ts); const now=new Date(); const diff=(now-d)/1000;
  if(diff<60) return "Just now";
  if(diff<3600) return Math.floor(diff/60)+" mins ago";
  if(diff<86400){
    if(now.getDate()===d.getDate()) return "Today "+d.getHours()+":"+d.getMinutes().toString().padStart(2,"0");
    if(now.getDate()-d.getDate()===1) return "Yesterday "+d.getHours()+":"+d.getMinutes().toString().padStart(2,"0");
    return d.toLocaleString('en-US',{weekday:'long',hour:'2-digit',minute:'2-digit'});
  }
  if(diff<7*86400) return Math.floor(diff/86400)+" days ago";
  return d.toLocaleDateString();
}

function loadChats(){
  const stored=JSON.parse(localStorage.getItem("symptom_chats")||"[]");
  const now=Date.now();
  const valid=stored.filter(c=>!c.time||now-c.time<7*24*60*60*1000);
  localStorage.setItem("symptom_chats",JSON.stringify(valid));
  return valid;
}

function saveChat(role,text){
  const chats=loadChats();
  chats.push({role,text,time:Date.now()});
  localStorage.setItem("symptom_chats",JSON.stringify(chats));
  updateSummary();
}

function updateSummary(){
  const chats=loadChats();
  let moderate=0,urgent=0;
  chats.forEach(c=>{
    if(c.role==="ai"){
      if(/moderate/i.test(c.text)) moderate++;
      else if(/urgent/i.test(c.text)) urgent++;
    }
  });
  let summary="No severity data yet.";
  if(moderate||urgent) summary=`Session Severity ‚Üí ‚ö†Ô∏è Moderate: ${moderate}, üö® Urgent: ${urgent}`;
  severitySummary.textContent=summary;
}

function renderChats(){
  chatContainer.innerHTML="";
  loadChats().forEach(c=>{
    const div=document.createElement("div");
    div.className="bubble "+c.role;
    div.innerHTML=c.text+'<div class="timestamp" title="'+new Date(c.time).toLocaleString()+'">'+timeAgo(c.time)+'</div>';
    chatContainer.appendChild(div);
  });
  chatContainer.scrollTop=chatContainer.scrollHeight;
  updateSummary();
}

renderChats();
userInput.addEventListener("input",()=>{btnSend.disabled=!userInput.value.trim();});

function highlightSymptoms(text){
  symptomKeywords.forEach(word=>{
    const regex=new RegExp(`(?<!\\w)${word}(?!\\w)`,"gi");
    text=text.replace(regex,`<span class="highlight">${word}</span>`);
  });
  return text;
}

function formatLists(text){
  text=text.replace(/(?:^|\n)(?:\s*[*#-]\s.+\n?)+/gm,m=>{
    const items=m.trim().split(/\n/).map(l=>"<li>"+l.replace(/^\s*[*#-]\s+/,"")+"</li>").join("");
    return "<ul>"+items+"</ul>";
  });
  text=text.replace(/(?:^|\n)(?:\s*\d+\.\s.+\n?)+/gm,m=>{
    const items=m.trim().split(/\n/).map(l=>"<li>"+l.replace(/^\s*\d+\.\s+/,"")+"</li>").join("");
    return "<ol>"+items+"</ol>";
  });
  return text;
}

async function sendMessage(){
  const text=userInput.value.trim();
  if(!text) return;
  appendUser(text);
  userInput.value="";
  btnSend.disabled=true;
  try{
    const chats=loadChats();
    const systemPrompt=`You are SalFa AI, a caring human-like doctor.
You deal ONLY with health concerns.
Talk naturally, like chatting with a patient (warm, friendly tone).
- Use emojis like üò∑ü§íüíäü©∫ where appropriate.
- Acknowledge feelings first, then highlight symptoms (<span class="highlight">).
- Use proper bullets and numbering for lists.
- Mention severity (moderate/urgent) only if relevant.`;

    const response=await fetch("https://salfa-supper-app-2tg9.vercel.app/Api/Chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        model:"openai/gpt-4o-mini",
        messages:[
          {role:"system",content:systemPrompt},
          ...chats.map(c=>({role:c.role==="user"?"user":"assistant",content:c.text})),
          {role:"user",content:text+" Respond in "+lang+" with a human friendly style."}
        ]
      })
    });

    if(!response.ok) throw new Error("Network error");
    const data=await response.json();
    const reply=data.choices?.[0]?.message?.content||"Error connecting to AI";
    appendAI(reply);
  }catch(err){
    appendAI("Error connecting to AI service.");
    console.error(err);
  }
}

function appendUser(text){
  saveChat("user",highlightSymptoms(text));
  renderChats();
}

function appendAI(text){
  let display=formatLists(highlightSymptoms(text));
  if(/moderate/i.test(text)){
    display+="<div class='severity moderate'>‚ö†Ô∏è <b>Moderate:</b> Follow home care, monitor symptoms, consult doctor if persistent.</div>";
  } else if(/urgent/i.test(text)){
    display+="<div class='severity urgent'>üö® <b>URGENT:</b> Seek immediate medical attention!</div>";
  }

  const typingDiv=document.createElement("div");
  typingDiv.className="bubble ai";
  chatContainer.appendChild(typingDiv);
  chatContainer.scrollTop=chatContainer.scrollHeight;

  let i=0;
  function typeChar(){
    if(i<=display.length){
      typingDiv.innerHTML=display.slice(0,i)+"<span class='cursor'></span>";
      chatContainer.scrollTop=chatContainer.scrollHeight;
      typeSound.currentTime=0;
      typeSound.play().catch(()=>{});
      i++;
      setTimeout(typeChar,15);
    } else {
      typingDiv.innerHTML=display+'<div class="timestamp">'+timeAgo(Date.now())+'</div>';
      saveChat("ai",display);
      renderChats();
    }
  }
  typeChar();
}

btnSend.addEventListener("click",sendMessage);
userInput.addEventListener("keypress",(e)=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}});
chatContainer.addEventListener("scroll",()=>{scrollUpBtn.style.display=chatContainer.scrollTop>100?"block":"none";});
scrollUpBtn.addEventListener("click",()=>{chatContainer.scrollTop=0;});
userInput.addEventListener('input',()=>{userInput.style.height='auto';userInput.style.height=Math.min(userInput.scrollHeight,200)+'px';});
</script>
</body>
</html>
